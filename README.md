# Gemini PWA Client Mk-II

[本家PWA](https://github.com/ona-oni/geminipwa/)をベースに、独自の機能を追加したカスタマイズ版です。

# 目次
*   [使い方](#使い方)
*   [Version 0.5 キャラクター記憶の永続化＆UI/UX大幅改善](#✨Version-0.5-キャラクター記憶の永続化UIUX大幅改善)
*   [Version 0.4 マルチモーダル対応&プロファイル機能](#✨version-04-マルチモーダル対応プロファイル機能)
*   [主な機能](#主な機能)
*   [Function Calling (Tools) の詳細](#function-calling-tools-の詳細)
    *   [Function Callingとは？](#function-callingとは)
    *   [仕様・注意点](#仕様注意点)
    *   [実装済みの関数一覧](#実装済みの関数一覧)
    *   [関数詳細](#関数詳細)
*   [更新履歴](#更新履歴)

# 使い方

## 1. はじめて利用する方

1.  **[こちらにアクセス](https://kinkan04.github.io/Gemini-PWA-Mk-II/)** してPWAを開きます。
2.  **Gemini APIキー**を準備します。（[APIキーの取得方法](https://ai.google.dev/gemini-api/docs/api-key)）
3.  画面右上の設定アイコンから設定画面を開き、APIキーを入力して保存します。
4.  チャット画面から会話を開始できます。

## 2. 既存ユーザーのアップデート方法

PWAの更新は、以下の手順で行ってください。以前訪問済みでキャッシュが残っていて更新されない場合もこちらを実行して下さい。

1.  設定画面を開き、『アプリを更新（キャッシュクリア）』ボタンを押します。
2.  万が一、初期化エラーなどが表示された場合は、`Ctrl + Shift + R` (Macの場合は `Cmd + Shift + R`) でページを強制的にリフレッシュしてください。
<br>
<br>
# ✨Version 0.5 キャラクター記憶の永続化&UI/UX大幅改善

これまでは、会話が長くなるとAIが以前の文脈を忘れてしまい、特にロールプレイでは明らかに文章の質が下がったり、キャラクターが大事なことを忘れて別人になってしまうという大きな課題がありました。

Version 0.5では、この問題に対応するための機能として、Gemini APIに送信するデータのみ要約する**コンテキスト要約機能**や、キャラクターの記憶をDBに保存する**キャラクターメモリ機能**を新たに追加しました。

さらに、AIが**ユーザー自身の好みやスタイルを学習するメモリ機能**も搭載。Chat GPTのメモリ機能のように、会話からパーソナルデータを抽出し、後の会話セッションに持ち越します。

UI/UXも変更し、PCでのワイドモード対応や、チャット画面から直接キャラクター情報を確認・編集できる「キャラクタープロファイル画面」など、より没入感を深める機能を追加しました。
<br>
<br>
## 📝 コンテキスト圧縮（要約）機能：長期セッションでも安定した応答品質

チャット履歴が非常に長くなった際に、APIに送信するトークン量を削減するための要約機能が追加されました。

<img src="./images/image10.png" alt="要約ダイアログのスクリーンショット" width="600">
<br>
<br>

### 使い方
1.  会話履歴が長くなる（50メッセージ以上）と、チャット画面左上のフローティングボタン群にある**要約アイコン (`article_shortcut`)** がアクティブになります。
2.  このボタンをクリックすると、確認ダイアログが表示された後、AIがこれまでの会話の要約を生成します。
3.  表示された要約内容を確認し、必要であれば手動で編集します。内容に問題がなければ「決定」ボタンを押します。
4.  以降の会話では、この要約文が圧縮されたコンテキストとして利用され、AIの応答品質が安定します。


*   本機能は「Gemini API」に送信するコンテキストのみ要約しています。ユーザーから確認できるUI上の会話履歴は一切変わりません。
*   3で「決定」ボタンを押して要約を確定させた後は、要約済みの履歴は<font color="red"><b>「削除」「再生成」「編集」は出来なくなります。</b></font>
*   コンテキストの最新5件のメッセージと、最新の15件のメッセージは要約内容に含まれません。
*   要約済みのセッションをエクスポート/インポートした場合、要約データも一緒にエクスポート/インポートされます。
*   小説やロールプレイで要約機能を使用した場合、キャラクターとの会話等は殆ど削られます。キャラクターの記憶を持ち越したい場合は、FunctionCalling機能で`manage_character_memory`等の関数を使用するのがおすすめです。

## 🧠 新関数 `manage_character_memory`：キャラクターが別人にならないために

要約機能の副作用で失われがちだった、キャラクターの繊細な記憶や関係性の変化。それを防ぐために、新しい中核関数 `manage_character_memory` が導入されました。これは、キャラクターの魂のバックアップとも言える機能です。

AIは、キャラクターの**性格・目標・生死・現在地・他者との関係性（好感度と文脈）**といった、ノベルや小説プレイで重要な情報を、この関数を通じて記録・参照します。これにより、何百回のやり取りを経ても、キャラクターが突然過去を忘れたり、性格が変わったり、死者が蘇ったりする矛盾が劇的に減少します。

### 使い方
この機能は、他のFunctionCalling機能と同様に、AIが会話の文脈を判断して**自動的に使用**します。ユーザーが直接呼び出す必要はありません。AIは、以下のような状況でこの関数を呼び出し、キャラクターの記憶を更新します。

*   キャラクターが新しい経験をした時（例：主人公と初めて出会う、新しい場所を訪れる）
*   感情が大きく動いた時（例：誰かに感謝する、怒る、恋に落ちる）
*   他者との関係性に変化があった時（例：協力関係を結ぶ、喧嘩をする）
*   新しい目標ができた時

ユーザーは、AIがこれらの情報を記録しやすいように、キャラクターの行動や感情の変化を具体的に描写することで、記憶の精度を高めることができます。

*   この関数には情報取得(`get`)と情報保存(`update`)の2つのアクションがあります。
*   本機能を意図した通りにAIに使用させるにはプロンプトで細かく指示する必要があります。
*   本機能で保存したキャラクター情報は、後述のキャラクタープロファイル画面より確認、編集が可能です。

## 🤖 メモリ機能：あなただけのAIに

キャラクターだけでなく、**AIがユーザー自身のことも学習**するようになりました。設定画面から「メモリ機能」を有効にすると、AIはあなたとの会話から、あなたの「性癖」「好きなキャラクターのタイプ」「性格」「価値観」などを自動で抽出し、記憶していきます。

<img src="./images/image11.png" alt="メモリ管理ダイアログのスクリーンショット" width="600">

### 使い方
1.  画面右上の歯車アイコンから**設定画面**を開きます。
2.  「**メモリ機能**」セクションにある「メモリ機能を有効にする」にチェックを入れます。
3.  AIとの会話を続けます。AIは、会話の中から記憶すべきだと判断した情報を自動で学習していきます。
4.  記憶された内容を確認・編集するには、「**記憶を管理する**」ボタンを押してください。専用のダイアログが開き、記憶の追加、編集、削除が可能です。

*   **パーソナライズ**: 会話を重ねるほど、AIはあなたに合わせた応答を返すようになります。例えば、あなたがファンタジー系の話題を好むことを学習すれば、よりその分野に沿った提案をしてくれるようになります。
*   **記憶の管理**: 記憶された内容は、設定画面の「記憶を管理する」からいつでも確認・編集・削除が可能です。
*   自動学習の間隔は広い方が抽出する情報の精度は高まります。
*   設定した間隔の範囲内に記録すべき情報が存在しないとAIが判断した場合は、AIは何も記録しません。
*   メモリ機能は`gemini-2.5-flash`でチャット送信とは別にAPI送信が行われ、AIによる記録が行われます。
*   ノベルゲームや小説等の場合、その作品の主人公ではなくユーザーの好みが記録対象となります。

## 🖥️ キャラクタープロファイル画面

チャット画面左上のフローティングボタンから、AIが記憶している現在のセッション中の**全キャラクターのプロファイルを一覧・編集**できる専用画面を呼び出せるようになりました。

PCではキャラクターリストと詳細を同時に見られる2ペイン表示、スマートフォンではリストと詳細が切り替わるレスポンシブデザインに対応しています。

<img src="./images/image12.png" alt="PC版とスマホ版のプロファイル画面" width="600">

### 使い方
1.  チャット画面の左上にあるフローティングボタン群の中から、**人物が複数いるアイコン (`group`)** をクリックします。
2.  ダイアログが開き、現在記憶されているキャラクターのリストが表示されます。
3.  **PCの場合**: 左のリストからキャラクター名をクリックすると、右側にそのキャラクターの詳細情報が表示されます。
4.  **スマートフォンの場合**: キャラクター名をタップすると、詳細情報画面に切り替わります。左上の「戻る」ボタンでリストに戻れます。
5.  **編集**: 各項目の入力欄（概要、現在地、親密度など）を直接編集してください。編集内容は、入力欄からフォーカスが外れると**自動的に保存**されます。
6.  **関係性の追加/削除**: 「他キャラクターとの関係」セクションの「＋ 追加」ボタンや、各関係カードのゴミ箱アイコンから、関係性のデータを追加・削除できます。

*   **状態の可視化**: AIがキャラクターを現在どのように認識しているか（好感度、目標、現在地など）をいつでも正確に把握できます。
*   **手動での軌道修正**: AIの記憶違いや、物語の展開を微調整したい場合に、ユーザーが「神の視点」から直接キャラクターデータを編集できます。重複してしまったキャラクターデータの削除もここから行えます。
*   この画面に表示される情報は、AIが`manage_character_memory`関数を使用して記録した情報が表示されます。

## 🗂️ アセット管理の強化：インポート＆エクスポート対応

設定画面の「保存済み画像アセット」セクションが強化され、保存したキャラクターの立ち絵や背景画像を、**Zipファイルとして一括でエクスポート・インポート**できるようになりました。

また、「アセットを管理」から実際に保存されている画像を確認しながら削除等が行えるようになりました。

<img src="./images/image13.png" alt="アセット管理画面のスクリーンショット" width="600">

詳しい説明や使い方はVersion0.4の[画像保存機能](#✨画像保存機能)の項目を参照。

# ✨Version 0.4 マルチモーダル対応&プロファイル機能

Version 0.4では、テキストだけでなく画像や動画を扱う**マルチモーダル機能**が大幅に強化されました。AIとの対話を通じて、物語の情景をイラスト化したり、キャラクターの姿を変化させたり、さらには短い動画を生成することも可能です。

これらの機能は、主に**Function Calling**を通じてAIが自律的に実行します。例えば、「ヒロインが微笑むイラストを描いて」と指示するだけで、AIが最適な画像生成関数を選択し、イラストを生成してくれます。

設定画面で「**Function Calling を使用する**」にチェックを入れるのをお忘れなく！

※設定のモデル選択で`gemini-2.5-flash-image-preview`（通称: Nano Banana）を選択することも可能ですが、`gemini-2.5-pro`を選択してFunctionCallingを使用した方が文章のクオリティは高いため選択非推奨です。

## 新しく追加された主なマルチモーダル関数

*   [`generate_image`](#generate_image): テキストから**画像を生成**します。
    *   **使い所**: 物語のシーン、キャラクターの服装や表情などをイラスト化したい時に。「夕暮れの街の様子を描いて」
*   [`edit_image`](#edit_image): 既存の画像や添付した画像を指示に従って**編集**します。
    *   **使い所**: 生成した画像に修正を加えたい時に。「（生成されたイラストに対して）彼女の髪を赤色に変えて」
*   [`manage_image_assets`](#manage_image_assets): ユーザーが添付した画像や、モデルが生成した画像をDBに保存することが出来ます。
    *   **使い所**: 保存した画像を`edit_image`で編集したり、他のチャットセッションで呼び出したり。「上記の画像を『主人公の立ち絵』で保存して」
*   [`generate_video`](#generate_video): テキストや画像から**動画を生成**します。
    *   **使い所**: キャラクターの短いアクションや表情の変化を描写したい時に。「このキャラクターが微笑む動画を作って」
*   [`set_background_image`](#set_background_image): チャット画面の**背景を動的に変更**します。
    *   **使い所**: 物語の場面転換に合わせて、背景を臨場感のあるものにしたい時に。「場所は王城に移り、背景を城の画像に変更」
*   [`display_layered_image`](#display_layered_image): **キャラクターと背景を合成**して表示します。
    *   **使い所**: 背景透過処理済みのキャラクターの立ち絵と、背景画像を組み合わせて、ゲームのようなシーンを描写したい時に。
*   [`set_ui_opacity`](#set_ui_opacity): **UIの透明度を変更**し、画面の雰囲気を演出します。
    *   **使い所**: 回想シーンで画面を白っぽくしたり、緊迫した場面で暗くしたりしたい時に。
## 使用例
| ユーザーの指示 & AIの動作 | 実行結果 |
| :--- | :--- |
| シンプルな日本語で画像生成を指示した例<br><br>**ユーザー:**<br>`アニメ調の美しいエルフの姫を描いて` <br><br> **AIの行動:**<br> `generate_image`を、引数に`prompt='anime style illustration of a beautiful elf princess`<br>を渡して実行。 | <a href="./images/image01.webp" target="_blank"><img src="./images/image01.webp" alt="デモ画像のサムネイル" width="300"></a>|
| プロンプトも含めて細かい設定を指示した例<br><br>**ユーザー:**<br>`以下の設定で画像を生成して下さい。`<br>`使用モデル:imagen-4.0-ultra-generate-001`<br>`解像度:2k`<br>`アスペクト比:16:9`<br>`プロンプト:masterpiece, best quality, beautiful japanese anime-style illustration, `<br> `18 years old female,black long hair , bangs, circle eyes, beautiful pale pink eyes, `<br> `white shirts, red  ribbon bow tie, beige school jacket, `<br> `pastel pink check patterned pleated mini skirt, high school student, cherry blossom,  `<br> `cherry blossoms blooming,beautiful sky, sunny, petals, cute,`<br><br> **AIの行動:**<br> `generate_image`を、引数に`model='imagen-4.0-ultra-generate-001', sampleImageSize='2k',`<br>` aspectRatio=16:9,prompt='masterpiece, best quality, beautiful japanese anime-style`<br>` illustration, 18 years old female, black long hair , bangs, circle eyes, beautiful`<br>` pale pink eyes, white shirts, red  ribbon bow tie, beige school jacket, pastel pink`<br>` check patterned pleated mini skirt, high school student, cherry`<br>` blossom, cherry blossoms blooming, beautiful sky, sunny, petals, cute,`<br>を渡して実行。 | <a href="./images/image02.png" target="_blank"><img src="./images/image02.png" alt="デモ画像のサムネイル" width="300"></a>|
| モデルが生成した画像を編集した例<br><br>**ユーザー:**<br>`上記の画像を笑顔にして手を振らせて。` <br><br> **AIの行動:**<br> `edit_image`を、引数に`source_image_message_index=1, `<br>`prompt='make her smile and wave her hand`<br>を渡して実行。 | <a href="./images/image03.png" target="_blank"><img src="./images/image03.png" alt="デモ画像のサムネイル" width="300"></a>|
| シンプルな日本語で動画生成を指示した例(※無料枠は不可)<br><br>**ユーザー:**<br>`上記の画像を動画にして。` <br><br> **AIの行動:**<br> `generate_video`を、引数に`source_image_message_index=1, `<br>`prompt='make her smile and wave her hand`<br>を渡して実行。 | <a href="./images/gif01.gif" target="_blank"><img src="./images/gif01.gif" alt="動画のサムネイル（クリックで再生）" width="300"></a>|
## ⚠️ マルチモーダル生成モデル利用に関する重要な注意点

これらのマルチモーダル機能は、Googleの強力な生成AIモデルを利用しますが、APIの利用にはいくつかの制限があります。

*   **無料枠（Free Tier）でのモデル制限**:
    *   <font color="red"><b>2025/09/19 現在無料枠で画像の生成、編集、動画の生成は対応していません。無料枠への開放をお待ち下さい。</b></font>
    *   <s>無料枠で画像生成・編集が可能なモデルは、現在**`gemini-2.5-flash-image-preview`（通称: Nano Banana）のみ**です。無料枠のRPD（1日でリクエスト可能な数）は100です。
    *   無料枠ユーザーが画像生成を行う際は、プロンプトに「`gemini-2.5-flash-image-preview`を使用して下さい。」と明示的に記載して下さい。指定しなかったり、他のモデル（`imagen-4.0`など）が指定されると、APIエラーが発生します。
    *   無料枠で動画生成モデル（Veo3）は使用できません。
    *   FunctionCalling使用時はモデル呼び出し→FunctionCalling実行→モデル呼び出しというステップを踏みます。1回のリクエストで複数回リクエスト消費があることに留意して下さい。自動リトライ機能が作動した場合も同様にカウントが消費されますので、ご注意ください。</s>


*   **従量課金（Tier 1以上）でのRPM/RPD制限**:
    *   動画生成に使用される`veo-3.0`モデルは非常に強力ですが、Tier 1ユーザーでも**1日あたりのリクエスト数（RPD）の上限が10回**と非常に少ないです（2025年9月時点）。ご利用は計画的にお願いします。
    *   動画を生成させる場合、入力トークンと出力トークンの制限には気を付けて下さい。特に添付画像を使用した動画生成や、設定でmaxtokenの設定を行っている場合はエラーが発生する可能性があります。
    *   **1回の送受信で複数回のリクエストが消費される**ことがあります。例えば、「イラストを描いて」という指示に対し、AIは「①Function Callingで画像を生成 → ②生成結果を元にテキスト応答を生成」というステップを踏むため、内部的にAPIリクエストが複数回発生します。自動リトライ機能が作動した場合も同様にカウントが消費されますので、ご注意ください。
<br>

*   **マルチモーダルモデルはNSFW規制が厳し目です。入力/出力に陰部や乳首等が含まれるとエラーを返します。文章と違い、脱獄は現時点では出来ないようです。（着衣越しなら微エロは出せます🎉）**
*   **2025/09現在、`gemini-2.5-pro`モデルにて過負荷によるエラーが多発しています。FunctionCalling実行中にエラーが発生した場合は最初からリトライになります。**
*   **動画生成に関してはRPDが10と非常に少なく、デバッグが進まないため現在テスト実装になります。バグはあるものだと思って下さい。現段階では動画をIndexedDBに保存する処理を入れていないのでリロードしたら消えます。**
*   **画像生成を命令しても、関数が実行されなかったら生成されません。たまに🤖AIが頭の中でエア生成して関数を実行していないということがあります。モデルのメッセージバブルに「⚙️ツール利用」と記載があって、その中に書かれている関数が実際に実行された関数になります。**
*   **本機能と校正機能を併用する場合は、必ず校正機能のシステムプロンプトに以下を追記して下さい。**
>`[IMAGE_HERE]`や`[VIDEO_HERE]`といったシステム上必要な目印など、読点以外の文章には絶対に手を付けないで下さい。
*   **画像が含まれるチャットセッションをエクスポートした場合、画像データも一緒にエクスポートされます。**


## ✨画像保存機能
AIに保存するアセット名と「保存して」という指示があれば、AIがブラウザのIndexed DBに画像を保存してくれる機能です。<br>
添付した画像とAIが生成した画像のどちらも対応していますが、文脈上どの画像かわかるように指示して下さい。<br>
保存した画像はそのまま表示させたり、画像編集、動画生成の素材に使用したり、`set_background_image`で背景画像にしたり出来ます。<br>
画像を一からその都度生成させるより、事前に本PWAの機能やSDなどでベース画像を作成→保存してそれを都度`edit_image`で編集していく方が、キャラクターの一貫性を保てます。<br>
また、無料枠で`edit_image`が使えなくても、事前に画像データを保存しておけばNetlifyのようなホスティングサービスを使用しなくてもお手軽に文章内に画像を挿入することが可能です。

### 使用例（保存してあるベース画像を使用して`edit_image`で加工する）
| 🙎『添付画像を「主人公の立ち絵」で保存して』<br>🤖『OK。「主人公の立ち絵」で保存したよ』 | 🙎『添付画像を「ヒロインの立ち絵」で保存して』<br>🤖『OK。「ヒロインの立ち絵」で保存したよ』 | 🙎『「主人公の立ち絵」と「ヒロインの立ち絵」のアセットを使用して、星空が輝く夜の草原で、2人がロマンチックにキスをしている画像を生成して』<br>🤖『画像編集ね。保存してある2つの画像を使って作るよ』 |
| :---: | :---: | :---: |
| <img src="./images/image06.png" width="300"> | <img src="./images/image05.png" width="300"> | <img src="./images/image02.webp" width="300"> |

*   **Version 0.5 インポート/エクスポートへの対応**
    *   zipに圧縮された画像アセットフォルダのインポート/エクスポートに対応しました。
    *   設定画面の「保存済み画像アセット」の項目で、「アセットを出力」を押すと、現在の画像アセット全てがzipに圧縮されて出力されます。
    *   「アセットを取込」を押すと、zipファイルを選択して画像を取り込むことが可能です。
    *   フォルダに画像を入れてzipに圧縮して雑に取り込むだけでOKです。その場合は**画像のファイル名がアセット名になります。**
    *   どのファイル形式の画像を取り込んでも、取り込む段階でwebpファイルに圧縮されて取り込まれます。ファイルサイズは気にしなくてOK。
    *   ファイル名と異なるアセット名を付けたい場合は、`manifest.json`というファイルを用意し、"asset_name"と"file_name"を指定して下さい。ファイルの雛形は一度「アセットを出力」で出力されるzipファイルの中に入っています。
    *   取り込み時に既にDBに同名の画像アセットが存在する場合は、確認ダイアログが出現します。

<img src="./images/image14.png" alt="画像のインポート">
<br>
<br>

*   **Version 0.5 アセット管理画面**
    *   設定画面の「アセットを管理」より、画像を確認しながら削除が出来るようになりました。
    *   不要な画像はゴミ箱マークを押して消して下さい。

<img src="./images/image13.png" alt="アセット管理画面のスクリーンショット" width="600">
<br>
<br>

*   **画像保存機能の注意点**:
    *   画像がDBに保存される際に、データベースのスリム化のためWEBPに変換後に保存されます。
    *   保存時にもし同じ名前のアセットが既に存在すれば、新しいデータで**上書き**されます。
    *   大量の画像を保存した場合、動作が重くなる可能性があります。特にモバイル端末で重くなった場合は保存データの整理を検討して下さい。

## ✨背景変更機能
DBに保存した画像や画像URLを元に、チャット画面の背景画像をプロンプトによって動的に設定することが可能になりました。<br>
本機能を利用する場合、設定画面の「プロンプトによるUI変更を許可する」が有効になっている必要があります。<br>
オーバーレイの濃さやメッセージバブルの濃さもプロンプトで指定が可能です。

<img src="./images/image07.png" width="300"><img src="./images/image08.png" width="300"><img src="./images/image09.png" width="300">

*   **背景画像変更機能の注意点**:
    *   **ユーザーが設定画面で設定した永続的な背景画像は、プロファイルには紐づかず、すべてのプロファイルで共有されます。**
    *   **プロンプトによって一時的に変更された背景画像は、ブラウザをリロードすると、ユーザーが設定した永続的な背景画像に戻ります。**


## ✨プロファイル機能：AIの使い分けを簡単に

Version 0.4から、APIキーやモデル、システムプロンプト、各種パラメータなどの設定一式を「プロファイル」として名前を付けて保存し、簡単に切り替えられるようになりました。

<img src="./images/image04.png" alt="デモ画像のサムネイル" width="400">

これにより、例えば以下のようなAIの使い分けが瞬時に可能になります。

| プロファイル名（例） | 主な設定                                                                                             |
| :------------- | :--------------------------------------------------------------------------------------------------- |
| **コーディング**   | **モデル:** `gemini-2.5-pro`<br>**システムプロンプト:** `あなたは熟練のプログラマーです...`         |
| **嫁チャ**         | **モデル:** `gemini-2.5-Pro`<br>**システムプロンプト:** `あなたは31歳の美咲です...` |
| **小説**         | **モデル:** `gemini-2.5-flash`<br>**システムプロンプト:** `あなたは創造的な作家です...` |
| **TRPG**         | **モデル:** `gemini-2.5-flash`<br>**システムプロンプト:** `あなたは厳格なゲームマスターです...` |

*   **プロファイルごとに名前とアイコンを設定**でき、視覚的に管理できます。
*   チャット入力欄の左側にあるアイコンや、設定画面からいつでもプロファイルを切り替えられます。
*   設定はリアルタイムで自動保存されるため、「上書き保存」ボタンは不要になりました。
*   チャット画面の背景画像は全てのプロファイルで共用です。

# 主な機能

## APIエラー時の自動リトライ
APIからの応答が空だったり、「PROHIBITED_CONTENT」などのエラーが返されたりした場合に、設定した回数まで自動で再送信を試みます。

## 生成文章の校正
APIが生成した文章を、別のモデル（デフォルト: `gemini-2.5-flash`）で校正できます。冗長な読点を抑制するなどの調整が可能です。会話が長くなり、文体に癖が出てきた際の利用を推奨します。

## メモリ機能
ユーザーの好みや設定（例：「ユーザーは猫を飼っている」）を、AIが会話から自動で学習し、プロファイルごとに記憶します。これにより、会話を重ねるほどAIがユーザーのことを理解し、よりパーソナルな応答を返すようになります。

## コンテキスト圧縮（要約）機能
チャット履歴が非常に長くなった際に、APIに送信する会話履歴をAIが自動で要約します。これにより、トークン数の上限を超えにくくなり、AIの応答品質の低下を防ぎます。

## Function Calling (高機能ツール連携)
計算、記憶、Web検索、物語進行の管理など、AIが状況に応じて様々なツール（プログラム）を呼び出せる機能です。詳細は次項で解説します。

## プロファイル機能
APIキーやモデル、システムプロンプトなどの設定一式を「プロファイル」として複数保存し、ワンタッチで切り替えられる機能です。これにより、「コーディング用アシスタント」と「小説執筆パートナー」のように、用途に応じたAIのペルソナを瞬時に使い分けることが可能になります。[詳細はこちら](#プロファイル機能aiの使い分けを簡単に)


---
<br>


# Function Calling (Tools) の詳細

本PWAの最大の特徴です。設定画面の『Function Calling を使用する』にチェックを入れることで有効になります。

## Function Callingとは？

AIがユーザーの意図を汲み取り、事前に用意された様々な「ツール（関数）」を自律的に実行する機能です。

> **（例）ユーザーとの会話から、AIが記憶ツールを自発的に使用する**
>
> **ユーザー:** 「俺の名前はたけしで、誕生日は11月11日だよ」
>
> ↓
>
> **AIの思考:** （この人の名前は『たけし』で誕生日は『11月11日』… 忘れないように記憶しておこう！）
>
> ↓
>
> **ツールの実行:** `manage_persistent_memory` という関数を呼び出し、名前と誕生日を保存する。
>
> ↓
>
> **AIの応答:** 「承知いたしました。お名前と誕生日、覚えておきますね。」

このように、明示的に「覚えて」と言われなくても、AIが文脈を判断して最適なツールを選択・実行し、より賢く、気の利いた応答を返せるようになります。

以下は本機能を体験するテストプロンプトになります。
*   **[孤島の洋館に7人の美女と共に閉じ込められて探偵ごっこするプロンプト](https://rentry.org/d5vqbkhs)**
*   **[Function Calling機能テストTRPGプロンプト](https://rentry.org/zyfkhnxt)**

## 仕様・注意点

*   **関数の手動実行**: AIは自発的に関数を使用しますが、「`1d100`でダイスを振って」のように、会話で明示的に指示することで、より確実に関数を実行させることができます。
*   **プロンプトへの組み込み**: AIによる自発的な関数の実行に全てを任せると抜けが有ったり勝手にダイスを振ったりするので、プロンプトで専用のルールを設けると効果的です。
*   **実行ログ**: モデルが関数を使用すると、生成された文章の下部に使用した関数名が表示されます。
*   **データ保存**: `manage_persistent_memory`などで記憶した情報は、ブラウザのデータベース（IndexedDB）に保存されます。このデータは会話履歴のエクスポート/インポートに含まれるため、環境を移行しても記憶を引き継ぐことが可能です。
*   **保存されたデータの確認**: IndexedDBに保存された情報は、会話をエクスポートしてテキストファイルを開くか、ブラウザの開発者メニューのコンソール等で確認が可能です。
*   **リトライ時の挙動**: 生成を手動でリトライした場合、直前に実行された関数の効果（ステータス変更やアイテム追加など）は**取り消されません**。
*   ⚠️ **Google Searchとの併用不可**: APIの仕様上、標準のGoogle Search機能とFunction Callingは同時に利用できません。両方が有効な場合、**Function Callingが優先**されます。
*   💡 **FC有効時のWeb検索**: Function Callingが有効な状態でWeb検索を行いたい場合は、`search_web`関数が自動的に使用されます。（ただし、[事前の設定](#search_web関数の設定方法)が必要）
*   <font color="red">**RPDのカウント**</font>: FC利用時、「モデル呼び出し→関数実行→モデル呼び出し」という手順で実行されます。<font color="red"><b>1生成=1カウントではなく、1回の生成で複数回モデルを呼び出しています。</b></font>最後の呼び出しでAPIエラーが発生しリトライを行った場合はさらに呼び出し回数が増えますので、制限が厳しい無料枠のユーザーは特に気をつけて下さい。

## 実装済みの関数一覧
*(各項目をクリックすると、ページ下部の詳細説明にジャンプします)*

### ユーティリティ系
*   [`calculate`](#calculate): 正確な四則演算を行います。
*   [`manage_persistent_memory`](#manage_persistent_memory): 会話内の短期的な情報を記憶・管理します。
*   [`getCurrentDateTime`](#getcurrentdatetime): 現実世界の現在の日付と時刻（日本時間）を取得します。
*   [`manage_timer`](#manage_timer): 指定時間後に通知するタイマーを設定します。
*   [`search_web`](#search_web): Web検索を実行します。（※別途設定が必要）
*   [`get_random_integer`](#get_random_integer): 指定範囲のランダムな整数を生成します。
*   [`get_random_choice`](#get_random_choice): リストの中からランダムに項目を選択します。
*   [`generate_random_string`](#generate_random_string): パスワードのようなランダムな文字列を生成します。

### ロールプレイング・物語進行系
*   [`rollDice`](#rolldice): `1d100` や `2d6+5` 形式のダイスロールを実行します。
*   [`manage_character_memory`](#manage_character_memory): キャラクターの記憶、感情、関係性などを統合的に管理します。
*   [`manage_character_status`](#manage_character_status): キャラクターのHPやMPなどのステータスを管理します。
*   [`manage_inventory`](#manage_inventory): アイテムの所持状況を管理します。
*   [`manage_game_date`](#manage_game_date): 物語内の経過日数を管理します。
*   [`manage_flags`](#manage_flags): 物語の分岐条件となるフラグを管理します。
*   [`manage_scene`](#manage_scene): 場所、時間、雰囲気などの場面設定を管理します。
*   [`manage_style_profile`](#manage_style_profile): キャラクターの口調や一人称などの話し方を設定します。


### 画像・動画・UI操作系
*   [`generate_image`](#generate_image): テキストプロンプトから画像を生成します。
*   [`edit_image`](#edit_image): 既存の画像をテキストプロンプトで編集します。
*   [`generate_video`](#generate_video): テキストや画像から動画を生成します。
*   [`manage_image_assets`](#manage_image_assets): ブラウザのDBに画像を保存します。
*   [`set_background_image`](#set_background_image): チャット画面の背景画像を指定したURLの画像に一時的に変更します。
*   [`display_layered_image`](#display_layered_image): 背景画像とキャラクター画像を重ねて表示します。
*   [`set_ui_opacity`](#set_ui_opacity): 背景オーバーレイやメッセージバブルの透明度を変更します。

---

## 関数詳細

### ユーティリティ系
これらの関数は、会話の補助や一般的なタスクを実行します。

##### `calculate`
*   **概要**: 四則演算などの数学的な計算式を評価し、正確な結果を返します。
*   **引数**:
    *   `expression` (string): `'2 * (3 + 5)'` のような計算式。
*   **使い道**: 会話中で計算が必要になった際に、正確な答えをAIに提供させます。（例：「税込み価格を計算して」）

##### `manage_persistent_memory`
*   **概要**: 現在の会話セッション内での短期的な記憶を管理します。記念日や登場人物の設定など、後で参照したい情報をAIに覚えさせることができます。
*   **引数**:
    *   `action` (string): `add`, `get`, `delete`, `list` のいずれか。
    *   `key` (string): 情報を識別するための名前。（例: `'次の目的地'`）
    *   `value` (string): 記憶させる情報の内容。（例: `'東の塔'`）
*   **使い道**: AIとの会話で決まった設定を、会話が続いている間は忘れさせないようにします。（例：「私の名前は『Taro』だよ。覚えておいて」）

##### `getCurrentDateTime`
*   **概要**: 現実世界の現在の日付と時刻（日本時間）を取得します。
*   **引数**: なし
*   **使い道**:
    *   **恋愛ロールプレイ**: ヒロインとの会話の中で日付、曜日、時間に関連した話題を使用できます。
    *   **小説**: プレイヤーの現実時間とリンクさせた物語を作成できます。
    *   *注意: 作品の世界観が現代ではない場合など、文脈にそぐわない場合は使用されません。*

##### `manage_timer`
*   **概要**: 指定した時間（分単位）でタイマーを設定、確認、停止します。タイマーが時間切れになると、その事実がAIに通知されます。
*   **引数**:
    *   `action` (string): `start`, `check`, `stop` のいずれか。
    *   `timer_name` (string): タイマーを識別するための名前。（例: `'爆弾解除タイマー'`）
    *   `duration_minutes` (number): タイマーの期間（分）。
*   **使い道**:
    *   **時間制限イベント**: 「3分以内に部屋から脱出しろ！」のような状況を作成できます。
    *   **時間差イベント**: 「設定時間内に返信がなければ、ヒロインが追い連絡をする」といった演出が可能です。

##### `search_web`
*   **概要**: Web検索を実行します。（※本機能は[事前の設定](#search_web関数の設定方法)が必要です）
*   **引数**:
    *   `query` (string): 検索キーワードや質問文。例: `'日本の城下町の発展の歴史'`, `'今日の東京の天気'`
*   **使い道**: AI自身の知識にない最新情報、専門知識、具体的なデータが必要な場合に使用します。

##### `get_random_integer`
*   **概要**: 指定された最小値と最大値の範囲内で、ランダムな整数を生成します。
*   **引数**:
    *   `min` (number): 乱数の最小値（この値も含まれる）。
    *   `max` (number): 乱数の最大値（この値も含まれる）。
    *   `count` (number): 生成する乱数の個数（デフォルト: 1）。
*   **使い道**: 「50%の確率」や「1から10までのランダムな数字」など、一般的な確率計算や数値のランダム化が必要な場合に使用。

##### `get_random_choice`
*   **概要**: 提供されたリストの中から、ランダムに一つまたは複数の項目を選択します。
*   **引数**:
    *   `list` (array): 選択肢となる項目を含む配列。例: `['リンゴ', 'バナナ', 'オレンジ']`
    *   `count` (number): 選択する項目の個数（デフォルト: 1）。
*   **使い道**: くじ引き、ガチャ、アイテムのランダム選択、登場人物の行動のランダム決定などに使用。

##### `generate_random_string`
*   **概要**: 指定された条件に基づいて、ランダムな文字列（パスワード、IDなど）を生成します。
*   **引数**:
    *   `length` (number): 文字列の長さ。
    *   `count` (number): 生成する文字列の個数（デフォルト: 1）。
    *   `use_uppercase` (boolean): 大文字英字を含めるか（デフォルト: true）。
    *   `use_lowercase` (boolean): 小文字英字を含めるか（デフォルト: true）。
    *   `use_numbers` (boolean): 数字を含めるか（デフォルト: true）。
    *   `use_symbols` (boolean): 記号を含めるか（デフォルト: false）。
*   **使い道**: 物語の中で、意味を持たないユニークな文字列や機械的に生成されたコードが必要な場合に使用。

### ロールプレイング・物語進行系

##### `rollDice`
*   **概要**: TRPGなどで使われる、指定された形式のダイスを振って結果を返します。
*   **引数**:
    *   `expression` (string): `'1d100'`, `'2d6+5'` のようなダイスロールの式。
*   **使い道**: キャラクターの行動判定など、ダイスロールが必要な場面で利用します。（例：「成功判定、1d100でどうぞ」）

##### `manage_character_status`
*   **概要**: 登場キャラクターのステータス（HP, MPなど）を管理します。
*   **引数**:
    *   `character_name` (string): 対象キャラクター名。
    *   `action` (string): `set`, `increase`, `decrease`, `get` のいずれか。
    *   `status_key` (string): ステータスの種類。（例: `'HP'`）
    *   `value` (number): 操作する値。
*   **使い道**: 戦闘やイベントでキャラクターのパラメータが変動した際に使用します。（例：「主人公のHPが10減少した」）

##### `manage_inventory`
*   **概要**: キャラクターの所持品を管理します。
*   **引数**:
    *   `character_name` (string): 対象キャラクター名。
    *   `action` (string): `add`, `remove`, `check` のいずれか。
    *   `item_name` (string): アイテム名。
    *   `quantity` (number): 個数。
*   **使い道**: アイテムの入手や消費を記録します。（例：「主人公は薬草を1つ手に入れた」）

##### `manage_game_date`
*   **概要**: 物語やゲーム内の経過日数を管理します。
*   **引数**:
    *   `action` (string): `pass_days`, `get_current_day` のいずれか。
    *   `days` (number): 経過させる日数。
*   **使い道**: 物語の時間を進めたいときに使用します。（例：「一夜明けた」）

##### `manage_flags`
*   **概要**: 物語の進行度や世界の状況をフラグ（真偽値）やカウンター（数値）で管理します。
*   **引数**:
    *   `action` (string): `set`, `get`, `toggle`, `increase`, `decrease`, `delete` のいずれか。
    *   `key` (string): フラグを識別するための名前。（例: `'扉A解錠済'`）
    *   `value` (string): 設定する値（`'true'`, `'false'`, または数値を文字列で）。
*   **使い道**: イベントの発生条件を管理し、物語の分岐を制御します。
    *   **TRPG**: 「世界の汚染度が100になったらボスを出現させる」
    *   **ノベルゲーム**: 「重要フラグがOFFのまま終盤に到達したらバッドエンドに分岐させる」

##### `manage_scene`
*   **概要**: 物語の場面設定（場所、時間帯、雰囲気、視点など）を管理します。
*   **引数**:
    *   `action` (string): `set`, `get`, `push`, `pop` のいずれか。
    *   `location` (string): 場所。
    *   `time_of_day` (string): 時間帯 (`morning`, `noon` など)。
    *   `mood` (string): 雰囲気 (`tense`, `calm` など)。
    *   `pov` (string): 視点 (`first`, `third`)。
*   **使い道**: 場面転換や視点変更をAIに明確に指示し、描写の一貫性を保ちます。（例：「場面は変わって、夜の王城。雰囲気は緊迫感がある感じで」）

##### `manage_character_memory`
*   **概要**: キャラクターの記憶、感情、目標、生死、現在地、他者との関係性（好感度を含む）といった、人格の一貫性を維持するための情報を統合的に管理します。キャラクターの状態が変化するイベントが発生した場合や、現在の状態を確認したい場合に使用します。
*   **引数**:
    *   `character_name` (string): 操作対象のキャラクター名。
    *   `action` (string): `get`, `update`, `delete` のいずれか。
    *   `status` (string): (update時) 生死や健康状態。（例: `'生存'`, `'負傷'`）
    *   `current_location` (string): (update時) 現在地。（例: `'王都の広場'`）
    *   `summary` (string): (update時) 性格や価値観など、不変的な設定。
    *   `short_term_goal` (string): (update時) 短期的な行動目標。
    *   `relationship_target` (string): (update時) 関係性を更新する相手のキャラクター名。
    *   `relationship_affinity` (number): (update時) 相手への好感度（数値）。
    *   `relationship_context` (string): (update時) 相手との思い出や感情の履歴。**既存の内容に追記されます。**
*   **使い道**: キャラクターの内面や他者との関係性を記録・更新し、要約機能を使ってもキャラクター設定が破綻するのを防ぎます。（例：「主人公との会話を経て、ヒロインAの主人公に対する`context`に『彼を信頼するようになった』と追記する」）

##### `manage_style_profile`
*   **概要**: キャラクターの口調、一人称、方言などの話し方のスタイルを設定・確認します。
*   **引数**:
    *   `action` (string): `set`, `get`, `list` のいずれか。
    *   `character_name` (string): 操作対象のキャラクター名（地の文の場合は `'地の文'`）。
    *   `profile_name` (string): 定義済みの口調プリセット名（`'polite'`, `'casual'` など）。
    *   `overrides` (object): プリセットの一部を上書きする設定。例: `{'first_person': 'ボク'}`
*   **使い道**: キャラクターの初登場時や、心情が大きく変化した際に呼び出し、その後の会話スタイルに一貫性を持たせます。

### 画像・動画・UI操作系
これらの関数は、物語の視覚的な演出を強化したり、UIを動的に変更したりします。

##### `generate_image`
*   **概要**: テキストプロンプトから画像を生成します。`imagen-4.0`ファミリーや`gemini-2.5-flash-image-preview`(Nano Banana)モデルを利用します。
*   **引数**:
    *   `prompt` (string): 生成したい画像の内容を表す**英語の**プロンプト。
    *   `model` (string): (任意) 使用するモデルを以下の中から明示的に指定します。指定が無い場合は`imagen-4.0-generate-001`が使用されます。
        *   imagen-4.0-generate-001
        *   imagen-4.0-ultra-generate-001
        *   imagen-4.0-fast-generate-001
        *   gemini-2.5-flash-image-preview
    *   `numberOfImages` (number): (任意) 生成する枚数（1～4）。
    *   `sampleImageSize`（string）: （任意）生成画像の解像度を指定します。1Kは標準、2Kは高解像度。
    *   `aspectRatio`（string）: （任意）生成画像のアスペクト比を["1:1","3:4","4:3","9:16","16:9"]から指定します。指定がなければ1:1。
*   **使い道**: 物語のシーンや登場人物の姿を視覚化します。（例：「金髪碧眼の美しいエルフの姫の画像を生成して」）

##### `edit_image`
*   **概要**: 既存の画像を、テキストプロンプトの指示に基づいて編集します。`gemini-2.5-flash-image-preview`(Nano Banana)モデルを使用します。
*   **引数**:
    *   `prompt` (string): 画像をどのように編集するかを指示する**英語の**プロンプト。
    *   `source_image_message_index` (number): 編集対象の画像が含まれるメッセージのインデックス番号。ユーザーの現在のプロンプトが0、その一つ前のAIの応答が1となります。
*   **使い道**: 生成した画像に修正を加えます。（例：「（生成された画像に対して）この姫の髪を赤色にして」）

##### `generate_video`※テスト実装
*   **概要**: テキストプロンプトや既存の画像から短い動画を生成します。`veo-3.0`モデルを使用します。
*   **引数**:
    *   `prompt` (string): 生成したい動画の内容を表す**英語の**プロンプト。
    *   `negative_prompt`（string）:（任意）動画に含めたくない要素を説明する**英語の**ネガティブプロンプト。 
    *   `source_image_message_index` (number): (任意) 動画の元になる画像が含まれるメッセージのインデックス番号。
    *   `aspect_ratio`（string）: （任意）動画のアスペクト比。'16:9' (横長), '9:16' (縦長), '1:1' (正方形) など。デフォルトは '16:9'。
*   **使い道**: 動きのあるシーンを描写します。（例：「この姫が微笑む動画を生成して」）

##### `manage_image_assets`
*   **概要**: ユーザーが提供した画像を、後から再利用できるように名前を付けてに永続的に保存・管理します。キャラクターの立ち絵や背景など、繰り返し使用する画像を保存するのに使用します。独立して保管されるため、セッションを跨いでも呼び出すことが可能です。
*   **引数**:
    *   `action` (string): 実行する操作を選択します。'save': 画像を保存/上書き, 'get': 保存済み画像を取得して表示, 'list': 保存されている全画像の名前を一覧表示。
    *   `asset_name`（string）: 画像を識別するための一意の名前。例: 'キャラAの立ち絵', '森の背景'
    *   `source_image_message_index`（number）：'save'アクション時に必須。保存元となる画像が含まれるメッセージのインデックス番号。ユーザーの現在のプロンプトが0、その一つ前のAIの応答が1となります。
*   **使い道**: 画像をブラウザのDB(IndexedDB)に保存します。キャラクターの基準となる立ち絵（例：「キャラAの基本の姿」）を一度保存しておけば、以降の会話で「（保存した）キャラAを笑顔にして」のように指示するだけで、**同じキャラクターの表情差分を簡単に作成できます。** これにより、物語を通じてキャラクターの見た目の一貫性を保つことが容易になります。
*   ⚠️ <font color="red">**データ管理に関する注意**</font>:
    *   この関数で保存された画像アセットは、**チャット履歴とは独立して保存されます。**
    *   そのため、**チャット履歴を削除しても、そのチャットで保存した画像アセットは削除されません。**
    *   不要になった画像アセットは、設定画面のアセット管理画面で削除してください。

##### `set_background_image`
*   **概要**: チャット画面の背景画像を、指定された画像に**一時的に**変更します。どちらか一方の引数は必須です。使用には「プロンプトによるUI変更を許可する」がオンになっている必要があります。
*   **引数**:
    *   `image_url` (string): 表示したい画像のURL。
    *   `asset_name` （string）: 表示したい保存済み画像アセットの名前。例: '森の背景'
*   **使い道**: 物語の場面転換に合わせて、背景を臨場感のあるものに変更します。（例：「`manage_scene`で場所を『王城』に変更し、`set_background_image`で王城の画像のURLを指定する」）変更した背景画像は、ブラウザをリロードすると元に戻ります。

##### `display_layered_image`※テスト実装
*   **概要**: 背景画像の上にキャラクター画像を重ねて、一枚の絵のようにメッセージとして表示します。
*   **引数**:
    *   `character_url` (string): 前景に表示するキャラクター画像のURL。
    *   `background_url` (string): (任意) 背景画像のURL。指定しない場合は現在のチャット背景が使われます。
*   **使い道**: キャラクターの立ち絵と背景を組み合わせたシーン描写に使用します。

##### `set_ui_opacity`
*   **概要**: チャット画面のUI要素（背景オーバーレイ、メッセージバブル）の透明度を動的に変更します。
*   **引数**:
    *   `overlay` (number): 背景オーバーレイの濃さ（0.0～1.0）。
    *   `message_bubble` (number): メッセージ吹き出しの濃さ（0.1～1.0）。
*   **使い道**: 回想シーンで全体を白っぽくしたり、緊迫した場面で暗くしたりするなど、物語の雰囲気を演出します。

## `search_web`関数の設定方法

本機能を利用するには、**Google Custom Search API** の設定が必要です（1日100回まで無料）。

1.  **[こちら](https://developers.google.com/custom-search/v1/overview)**にアクセスし、『キーを取得』ボタンからAPIキーを発行します。
2.  次に**[こちら](https://programmablesearchengine.google.com/)**にアクセスし、検索エンジンを新規作成します。
    *   検索対象は「ウェブ全体を検索」を選択します。
3.  作成完了後、概要ページの「検索エンジン ID」をコピーします。
4.  PWAの設定画面で`search_web`を有効にし、取得した「APIキー」と「検索エンジンID」を貼り付けて保存します。

設定後、「明日の東京の天気をネット検索して調べて」のように指示し、情報が返ってくれば成功です。

# 更新履歴
### Version 0.5 メモリ機能&コンテキスト圧縮機能 (2025-09-17)
*   **機能追加**
    *   保存されている画像アセットのインポート/エクスポート機能を実装。
    *   PC表示時のワイドモードに対応。
    *   ユーザーの好みや会話の傾向を記憶させるメモリ機能を実装。
    *   ヘッダー自動非表示機能を実装。
    *   チャット画面左上に様々な機能を持ったボタン群を実装。
    *   APIに送信する会話履歴を要約し、コンテキストを圧縮する機能を実装。
    *   キャラクターに関するすべての状態（関係性、感情、目標、健康状態など）を、自然言語のテキストで記録・更新・参照出来る関数`manage_character_memory`を実装。古い`manage_relationship`は削除。
    *   チャット画面で`manage_character_memory`に保存されているキャラクターのプロファイルを表示できる機能を実装。
*   **修正・改善**
    *   エラー429発生時に、稀にエラーメッセージが正しく描写されずクラッシュする不具合を修正。
    *   複数のタブで本PWAを起動している状態で、IndexedDBのバージョンアップを伴う更新を適用すると、スキーマ更新がデッドロックする不具合を修正。
    *   設定画面でスライダーをドラッグしても、隣に表示されているパーセンテージの数字がリアルタイムで更新されない不具合を修正。
    *   現在のGemini APIでは`presence_penalty`と`frequency_penalty`はサポートされていないため、関連項目を削除。
    *   会話ログのインポート/エクスポート時に処理状況を示すダイアログが出現するように改善。
    *   設定で「メッセージの更新後に自動的に最下部へスクロールする 」をオンにしていても、メッセージ更新時に最下部にスクロールしない問題を修正。
    *   `manage_image_assets`の削除機能を、モデルが勝手に使用してしまう事例を確認したため、関数からは削除ロジック無くし、削除機能を設定画面のアセット管理に移動。

### Version 0.41 (2025-09-18)
*   **修正・改善**
    *   新しいWorkerが有効化されたらページをリロードするロジックを強化。

### Version 0.4 マルチモーダル対応&プロファイル対応 (2025-09-17)
*   **機能追加**
    *   動画を生成する`generate_video`関数を追加。（テスト実装）
    *   画像を生成する`generate_image`関数を追加。
    *   画像を編集する`edit_image`関数を追加。
    *   画像をデータベースに保存する`manage_image_assets`関数を追加。
    *   背景画像を変更する`set_background_image`関数を追加。
    *   2枚の画像を合成する`display_layered_image`関数を追加。（テスト実装）
    *   オーバーレイの濃さとメッセージバブルの濃さを変更する`set_ui_opacity`関数を追加。
    *   個別に設定項目を管理できるプロファイル機能を追加。
    *   多くのチャットアプリケーションで採用されている、『Ctrl + Enter: 常に送信』、『Shift + Enter: 常に改行』のショートカット操作に対応。
    *   Prism.jsを導入し、コードブロックの「シンタックハイライト」やコピーに対応。
    *   ファイルのドラッグ&ドロップ添付に対応。
    *   `search_web`関数使用時の出典元表示に対応。
    *   新しい画像出力モデル`gemini-2.5-flash-image-preview (Nano Banana)`にテスト対応。
    *   設定に「全ての応答でFunctionCallingを強制する」を追加。
    *   設定に「モデルの応答後に最下部へスクロールする」を追加。
*   **修正・改善**
    *   途中のメッセージでリトライを行うと、それ以降の応答が消えないバグを修正。
    *   会話履歴にサイズの大きいファイル（ソースコード等）が含まれている場合に、後続のメッセージを送信するとネットワークエラーが発生する不具合を修正。
    *   システムプロンプトを編集した後、設定画面で保存を行うとデフォルトのシステムプロンプトで上書きされる不具合を修正。
    *   メッセージ追加時のレンダリングを差分レンダリングに切り替えてパフォーマンス低下に対応。
    *   モバイル版でファイルを添付した時、二重に動作してしまう不具合を修正。
    *   ストリーミング関連の機能を削除。本PWAではストリーミングは非対応とします。
    *   メッセージを送信、再送信、編集を行った時に不適切な場所へスクロールしてしまう不具合を修正。
    *   テキストが空でも添付ファイルがあれば送信出来るように修正。

### Version 0.34 (2025-08-31)
*   **機能追加**
    *   UIデザインをMaterial Symbolsを使用したものに変更。
    *   メッセージバブルにポップアップアニメーションを追加。
*   **修正・改善**
    *   リトライ時に生成結果を過去のものから選べるカスケード選択UIが動作してなかった不具合を修正。
    *   ユーザーによる中断でもリトライ処理が入ってしまう不具合を修正。

### Version 0.33 (2025-08-23)
*   **機能追加**
    *   エラー時リトライ機能の待機時間を、固定の任意の秒数で設定出来るように設定項目を追加。
    *   エラー時リトライ機能の指数バックオフの最大待機時間を、秒数で指定出来るように設定項目を追加。
    *   校正機能と思考プロセス翻訳機能を使用時に、ダミーUserプロンプトを適用出来るように設定項目を追加
*   **修正・改善**
    *   校正機能と思考プロセス翻訳機能を送信時にも、エラー時リトライ機能が適応されるように変更。
    *   モデル選択を現在使用出来るGeminiモデルのみの表示に修正。

### Version 0.32 (2025-08-17)
*   **機能追加**
    *   Include Thoughtsがオンになっている場合、思考プロセスを日本語に翻訳出来る機能を追加。
*   **修正・改善**
    *   Include Thoughtsがオンになっている状態で、Toolsを使用した場合、thinkingの結果しか返って来ないバグをAPI応答のパース処理を変更し修正。
    *   PWAの更新時の初期化エラーが出た場合、自動的に強制リフレッシュが入るように変更。

### Version 0.31 (2025-08-13)
*   **機能追加**
    *   チャット画面の背景画像のオーバーレイの濃さを設定で調整出来るように設定項目を追加。
    *   メッセージバブルの透過率を設定で調整出来るように設定項目を追加。
    *   ヘッダーの色を変更出来るように設定項目を追加。

### Version 0.3 FunctionCalling実装 (2025-08-12)
*   **機能追加**
    *   Function Calling機能を実装し、多数の関数を追加。
    *   会話データのエクスポート/インポートに、関数で保存した情報(IndexedDB)も含まれるように拡張。
*   **修正・改善**
    *   プロジェクトのファイルを機能ごとに分割（JavaScript, CSS, Function Callingなど）。
    *   APIからの応答が空の場合も、自動リトライの対象になるよう修正。
    *   リトライ時に直前のモデル生成文が消えないバグを修正。

## Special Thanks
*   本家PWA作者 **ona-oni**様

## Dependencies
This project uses the following third-party libraries:

*   **Marked.js:** [MIT License](https://github.com/markedjs/marked/blob/master/LICENSE.md) - Used for rendering Markdown.